syntax = "proto3";

package helm.v1alpha1;

import "google/api/annotations.proto";
import "google/protobuf/any.proto";
// import "google/protobuf/empty.proto";
option go_package = "./pkg/pb/;pb";


service HelmManagerService {
  // 1. 获取私有仓库中所有 Helm Chart 信息
  rpc ListCharts (ListChartsRequest) returns (ListChartsResponse) {
    option (google.api.http) = {
      get: "/v1alpha1/charts"
    };
  }

  // 2. 设置私有仓库地址和权限
  rpc ConfigureRepo (ConfigureRepoRequest) returns (ConfigureRepoResponse) {
    option (google.api.http) = {
      post: "/v1alpha1/repos"
      body: "*"
    };
  }

  // 3. 安装 Helm Chart
  rpc InstallChart (InstallChartRequest) returns (InstallChartResponse) {
    option (google.api.http) = {
      post: "/v1alpha1/{namespace}/charts/{release_name}/install"
      body: "*"
    };
  }

  // 4. 卸载 Helm Chart
  rpc UninstallChart (UninstallChartRequest) returns (UninstallChartResponse) {
    option (google.api.http) = {
      post: "/v1alpha1/{namespace}/charts/{release_name}/uninstall"
      body: "*"
    };
  }

  // 5. 监控 Chart 安装状态
  rpc WatchInstallStatus (WatchInstallStatusRequest) returns (stream InstallStatus) {
    option (google.api.http) = {
      get: "/v1alpha1/{namespace}/charts/{name}/status"
    };
  }

  // 6. 监控 Chart 下 Pod 状态
  rpc WatchPodStatus (WatchPodStatusRequest) returns (stream PodStatus) {
    option (google.api.http) = {
      get: "/v1alpha1/{namespace}/charts/{name}/pods"
    };
  }

  // 7. 检查已安装 Chart 是否包含 ApisixRoute 资源
  rpc CheckApisixRoute (CheckApisixRouteRequest) returns (CheckApisixRouteResponse) {
    option (google.api.http) = {
      get: "/v1alpha1/charts/{name}/apisix"
    };
  }

  // 8. 创建 Helm Chart 应用
  rpc CreateChartApplication (CreateChartApplicationRequest) returns (CreateChartApplicationResponse) {
    option (google.api.http) = {
      post: "/v1alpha1/applications"
      body: "*"
    };
  }

  // 9. 获取 Pod 日志
  rpc GetPodLogs (GetPodLogsRequest) returns (stream LogChunk) {
    option (google.api.http) = {
      get: "/v1alpha1/pods/{namespace}/{pod_name}/logs"
    };
  }

  // 10. 检查 Pod 是否支持终端交互
  rpc CheckPodTerminal (CheckPodTerminalRequest) returns (CheckPodTerminalResponse) {
    option (google.api.http) = {
      get: "/v1alpha1/pods/{namespace}/{pod_name}/terminal"
    };
  }

  // 11. 上传helm chart文件到默认仓库
  rpc UploadChartPackage(stream UploadChartPackageRequest) returns (UploadChartPackageResponse) {
    option (google.api.http) = {
      post: "/v1alpha1/chart/upload"
      body: "*"
    };
  }
}

// ========== 请求/响应结构定义 ==========

// 1. 获取 Chart 列表
message ListChartsRequest {
  string repo_name = 1;  // 私有仓库名称（可选）
  string keyword   = 2;
  int32 limit      = 3;
  int32 size       = 4;
}

message ChartInfo {
  string name = 1;           // Chart 名称
  string chart_version = 2;  // Chart 版本
  string icon_url = 3;       // 图标 URL
  string app_version = 4;    // 应用版本
  string description = 5;    // 应用描述
  string updateDate = 6;     // 更新时间
  string updateUser = 7;     // 更新者
}

message ListChartsData {
  int32 total = 1;
  int32 page_size = 2;
  int32 total_page = 3;
  int32 current_page = 4;
  repeated ChartInfo charts = 5;
}

message ListChartsResponse {
  int32 code = 1;
  string message = 2;
  bool success = 3;
  google.protobuf.Any data = 4;
}

// 2. 配置私有仓库
message ConfigureRepoRequest {
  string name = 1;          // 仓库名称
  string url = 2;           // 仓库地址
  string username = 3;      // 用户名（可选）
  string password = 4;      // 密码（可选）
  string ca_file = 5;       // CA 证书（可选）
}

message ConfigureRepoResponse {
  bool success = 1;
}

message K8sObject {
  google.protobuf.Any object = 1;  // 存储任意 Kubernetes 对象
}

message K8sObjectList {
  repeated K8sObject items = 1;  // 相当于 []runtime.Object
}

// 3. 安装 Chart
message InstallChartRequest {
  string name = 1;          // Chart 名称
  string release_name = 2;  // 安装的名称
  string version = 3;       // Chart 版本
  string namespace =4;     // 目标命名空间
  bool dry_run = 5;         // 检查chart文件是否合法
  string values = 6;        // values.yaml 内容（JSON/YAML 字符串）
}

message InstallChartResponse {
  int32 code = 1;
  string release_name = 2;  // 安装名称
  string first_deployed = 3;
  string last_deployed = 4;
  string deleted = 5;
  string message = 6;
  string status = 7;
  map<string, K8sObjectList> entries = 8;
}

// 4. 卸载请求参数
message UninstallChartRequest {
  string namespace = 1;             // 命名空间（从 URL 路径获取）
  string release_name = 2;          // Chart 名称（从 URL 路径获取）
  bool purge = 3;                   // 是否彻底删除（从 Body 或 Query 获取）
  map<string, string> options = 4;  // 其他卸载选项（如超时时间）
}

// 4. 卸载响应
message UninstallChartResponse {
  int32 code = 1;      // 是否成功
  string message = 2;    // 详细信息（如错误原因）
}

// 5. 监控安装状态
message WatchInstallStatusRequest {
  string name = 1;          // Chart 名称
  string namespace = 2;     // 命名空间
}

message InstallStatus {
  string phase = 1;         // Installing | Deployed | Failed
  string message = 2;       // 状态详情
}

// 6. 监控 Pod 状态
message WatchPodStatusRequest {
  string name = 1;          // Chart 名称
  string namespace = 2;     // 命名空间
}

message PodStatus {
  string pod_name = 1;
  string status = 2;       // Running | Pending | Failed
  string message = 3;
}

// 7. 检查 ApisixRoute
message CheckApisixRouteRequest {
  string name = 1;          // Chart 名称
  string namespace = 2;     // 命名空间
}

message CheckApisixRouteResponse {
  bool exists = 1;
  string route_url = 2;     // 访问方式（如 http://apisix-gateway/route）
}

// 8. 创建 Chart 应用
message CreateChartApplicationRequest {
  string namespace = 1;
  string name = 2;
  string chart_ref = 3;     // Chart 引用（如 repo/chart）
  string values = 4;        // values.yaml 内容
}

message CreateChartApplicationResponse {
  bool success = 1;
}

// 9. 获取 Pod 日志
message GetPodLogsRequest {
  string namespace = 1;
  string pod_name = 2;
  int32 tail_lines = 3;     // 日志行数（可选）
  bool follow = 4;          // 是否实时流式传输（可选）
}

message LogChunk {
  bytes content = 1;        // 日志内容（二进制流）
}

// 10. 检查 Pod 终端
message CheckPodTerminalRequest {
  string namespace = 1;
  string pod_name = 2;
  string container = 3;     // 容器名称（可选）
}

message CheckPodTerminalResponse {
  bool supported = 1;       // 是否支持终端
  string websocket_url = 2; // WebSocket 连接地址（如 ws://service/terminal）
}

message UploadChartPackageRequest {
  oneof data {
    ChartMetadata metadata = 1;  // 首次请求发送元数据
    bytes chunk = 2;             // 后续请求发送文件分片
  }
}

message ChartMetadata {
  string chart_name = 1;      // Chart 名称（如 "nginx"）
  string chart_version = 2;   // Chart 版本（如 "1.2.3"）
  string repo_name = 3;       // 目标仓库名（如 "stable"）
  string content_type = 4;    // 文件类型（如 "application/x-tar"）
}

message UploadChartPackageResponse {
  string chart_url = 1;       // 上传后的 Chart 访问路径
  uint64 size_received = 2;   // 服务端实际接收的字节数
  string digest = 3;          // 文件摘要（如 SHA256）
}
